<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aruna's Kitchen - Weekly Order Form</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            /* Warm Amber Color Scheme */
            --primary: #d97706;
            --primary-light: #f59e0b;
            --primary-dark: #b45309;
            --accent: #fcd34d;
            --accent-light: #fde68a;
            
            --bg-cream: #fef3c7;
            --bg-white: #ffffff;
            --bg-warm: #fffbeb;
            
            --text-dark: #92400e;
            --text-medium: #b45309;
            --text-muted: #d97706;
            
            --border-light: #fde68a;
            --border-warm: #fcd34d;
            
            --success: #16a34a;
            --success-bg: #dcfce7;
            --warning: #ea580c;
            --warning-bg: #ffedd5;
            --error: #dc2626;
            --error-bg: #fee2e2;
        }
        
        body {
            font-family: 'Source Sans Pro', sans-serif;
            background: var(--bg-cream);
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .hero {
            background: linear-gradient(135deg, var(--bg-white), var(--bg-warm));
            text-align: center;
            padding: 1.5rem 1rem;
            border-bottom: 3px solid var(--primary);
        }
        
        .logo-container {
            margin-bottom: 1rem;
        }
        
        #logo {
            max-width: 400px;
            width: 90%;
            height: auto;
            margin: 0 auto 1rem;
            display: block;
        }
        
        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(217, 119, 6, 0.1);
        }
        
        .phone-number {
            color: var(--text-muted);
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .week-header {
            margin-top: 0.75rem;
        }
        
        .week-label {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: var(--text-dark);
            font-weight: 600;
        }
        
        .cutoff-banner {
            background: var(--warning-bg);
            color: var(--warning);
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--primary-light);
        }
        
        .cutoff-banner strong {
            color: var(--primary-dark);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-header {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--text-dark);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent);
        }
        
        /* Menu Display */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .menu-day-tab {
            background: var(--bg-warm);
            border: 2px solid var(--border-warm);
            border-radius: 6px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .menu-day-tab:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .menu-day-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: var(--primary);
            color: white;
        }
        
        .menu-day-tab.unavailable {
            background: var(--error-bg);
            border-color: #fca5a5;
        }
        
        .menu-day-tab.unavailable .day-name,
        .menu-day-tab.unavailable .day-date {
            color: #991b1b !important;
        }
        
        .menu-day-tab .day-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            color: var(--text-dark);
        }
        
        .menu-day-tab.active .day-name {
            color: white;
        }
        
        .menu-day-tab .day-date {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .menu-day-tab.active .day-date {
            color: #fef3c7;
        }
        
        .menu-day-tab .unavailable-text {
            font-size: 0.75rem;
            color: #dc2626;
            margin-top: 0.25rem;
            font-weight: 600;
        }
        
        #menuContent {
            margin-top: 1rem;
        }
        
        .menu-items-list {
            background: var(--bg-white);
            border-radius: 6px;
            padding: 0.75rem;
        }
        
        .menu-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .menu-item-row:last-child {
            border-bottom: none;
        }
        
        .menu-item-name {
            flex: 1;
            color: var(--text-medium);
            font-weight: 500;
        }
        
        .menu-item-price {
            color: var(--primary);
            font-weight: 600;
            margin-left: 1rem;
        }
        
        /* Order Form */
        .day-order-section {
            background: var(--bg-warm);
            border: 2px solid var(--border-warm);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .day-selector {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 2px solid var(--border-warm);
            border-radius: 6px;
            background: white;
            margin-bottom: 1rem;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 80px 40px;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }
        
        .item-select, .size-select, .qty-select {
            padding: 0.5rem;
            border: 2px solid var(--border-light);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .qty-select {
            text-align: center;
        }
        
        .remove-btn {
            background: var(--error-bg);
            color: var(--error);
            border: none;
            border-radius: 4px;
            padding: 0.5rem;
            cursor: pointer;
            font-weight: bold;
        }
        
        .remove-btn:hover {
            background: var(--error);
            color: white;
        }
        
        .add-item-btn {
            background: var(--bg-white);
            color: var(--primary);
            border: 2px dashed var(--border-warm);
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .add-item-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .add-day-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .add-day-btn:hover {
            background: var(--primary-dark);
        }
        
        /* Form Inputs */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-warm);
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .radio-group {
            display: flex;
            gap: 1rem;
        }
        
        .radio-option {
            flex: 1;
        }
        
        .radio-option input[type="radio"] {
            display: none;
        }
        
        .radio-label {
            display: block;
            padding: 1rem;
            border: 2px solid var(--border-warm);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
        }
        
        .radio-option input[type="radio"]:checked + .radio-label {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .order-summary {
            background: var(--bg-warm);
            border: 2px solid var(--border-warm);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .summary-row.total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            padding-top: 0.5rem;
            border-top: 2px solid var(--border-warm);
            margin-top: 0.5rem;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 1.25rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
        }
        
        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .message {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .message.success {
            background: var(--success-bg);
            color: #065f46;
            border: 2px solid var(--success);
        }
        
        .message.error {
            background: var(--error-bg);
            color: #991b1b;
            border: 2px solid var(--error);
        }
        
        .hidden {
            display: none;
        }
        
        footer {
            background: var(--text-dark);
            color: var(--bg-cream);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            .logo-text {
                font-size: 2rem;
            }
            
            #logo {
                max-width: 250px;
            }
            
            .item-row {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="hero">
        <div class="logo-container">
            <img id="logo" src="https://somanad10.github.io/Kitchen-Orders/Logos.png" alt="Aruna's Kitchen Logo" onerror="this.style.display='none'">
            <h1 class="logo-text">Aruna's Kitchen</h1>
            <p class="phone-number">üìû +1 248-877-9924</p>
        </div>
        <div class="week-header">
            <p class="week-label" id="weekLabel"></p>
        </div>
    </div>
    
    <div class="cutoff-banner" id="cutoffBanner">
        <strong>‚è∞ Order Cutoff:</strong> <span id="cutoffMessage">Orders must be placed by 8 PM CST for next-day delivery.</span>
    </div>
    
    <div class="container">
        <!-- Menu Display -->
        <section class="section">
            <h2 class="section-header">This Week's Menu</h2>
            <div class="menu-grid" id="menuTabs"></div>
            <div id="menuContent"></div>
        </section>
        
        <!-- Order Form -->
        <form id="orderForm">
            <section class="section">
                <h2 class="section-header">Select Days & Items</h2>
                <div id="daysContainer"></div>
                <button type="button" class="add-day-btn" onclick="addDay()">+ Add Another Day</button>
            </section>
            
            <section class="section">
                <h2 class="section-header">Your Information</h2>
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" id="customerName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone *</label>
                    <input type="tel" id="customerPhone" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email (Optional - for confirmation)</label>
                    <input type="email" id="customerEmail" class="form-input">
                </div>
            </section>
            
            <section class="section">
                <h2 class="section-header">Fulfillment Method</h2>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" name="fulfillment" id="pickup" value="Pickup" checked>
                        <label for="pickup" class="radio-label">üè™ Pickup</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="fulfillment" id="delivery" value="Delivery">
                        <label for="delivery" class="radio-label">üöó Delivery ($2/day)</label>
                    </div>
                </div>
                <div class="form-group hidden" id="deliveryAddressGroup">
                    <label class="form-label">Delivery Address *</label>
                    <textarea id="deliveryAddress" class="form-textarea" rows="3"></textarea>
                </div>
            </section>
            
            <section class="section">
                <h2 class="section-header">Order Summary</h2>
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="summary-row hidden" id="deliveryFeeRow">
                        <span>Delivery Fee:</span>
                        <span id="deliveryFee">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                </div>
            </section>
            
            <div id="messageContainer"></div>
            
            <button type="submit" class="submit-btn" id="submitBtn">Place Order</button>
        </form>
    </div>
    
    <footer>
        <p>üçΩÔ∏è Freshly cooked ‚Ä¢ Homestyle flavors</p>
        <p style="margin-top: 0.5rem;">Aruna's Kitchen 2026</p>
        <div style="margin-top: 1rem; font-size: 0.75rem; color: #fcd34d;">
            <p>Orders subject to availability. Prices may change. Food allergy notification required.</p>
        </div>
    </footer>
    
    <script>
        // ===================================
        // CONFIGURATION
        // ===================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyeKFUUqRDSwgI9-fWRhqmANBPnE0eKqOzLLX8-GD-x4dUJWwsKVhq0hRd-SjAUfIDl/exec';
        const ORDER_CUTOFF_HOUR = 20; // 8 PM CST
        const TIMEZONE = 'America/Chicago'; // CST/CDT
        
        // ===================================
        // GLOBAL STATE
        // ===================================
        let menuData = [];
        let activeWeek = '';
        let dayCounter = 0;
        let itemCounter = 0;
        const orderDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        
        // ===================================
        // CST TIMEZONE FUNCTIONS
        // ===================================
        function getCSTParts() {
            const parts = new Intl.DateTimeFormat('en-US', {
                timeZone: TIMEZONE,
                weekday: 'short',
                hour: '2-digit',
                hour12: false
            }).formatToParts(new Date());

            const lookup = {};
            parts.forEach(p => lookup[p.type] = p.value);

            const hour = parseInt(lookup.hour, 10);
            const wd = lookup.weekday; // Sun, Mon, Tue...
            const map = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 };
            const jsDay = map[wd];

            return { hour, jsDay };
        }

        function isPastCutoffCST() {
            const { hour } = getCSTParts();
            return hour >= ORDER_CUTOFF_HOUR;
        }
        
        // ===================================
        // DAY AVAILABILITY LOGIC
        // CORRECTED: After 8 PM, can order day after tomorrow+
        // ===================================
        function isDayAvailableForOrdering(dayName) {
            // RULE 1: Sunday is NEVER available for online ordering
            if (dayName === 'Sunday') return false;
            
            const { hour, jsDay } = getCSTParts();
            
            // Convert JavaScript day (0=Sun, 1=Mon, etc.) to Monday-based index
            // Monday=0, Tuesday=1, ..., Sunday=6
            const currentDay = jsDay === 0 ? 6 : jsDay - 1;
            
            const dayIndexMap = {
                'Monday': 0, 'Tuesday': 1, 'Wednesday': 2, 'Thursday': 3,
                'Friday': 4, 'Saturday': 5, 'Sunday': 6
            };
            const targetDay = dayIndexMap[dayName];
            
            // RULE 2: Past days are blocked
            if (targetDay < currentDay) return false;
            
            // RULE 3: Today is blocked (no same-day ordering)
            if (targetDay === currentDay) return false;
            
            // RULE 4: Ordering rules based on time
            const daysUntil = targetDay - currentDay;
            
            if (hour < ORDER_CUTOFF_HOUR) {
                // Before 8 PM: Can order for tomorrow onwards
                return daysUntil >= 1;
            } else {
                // After 8 PM: Cannot order for tomorrow, but can order for day after tomorrow onwards
                return daysUntil >= 2;
            }
        }
        
        function getAvailableDays() {
            const available = orderDays.filter(day => isDayAvailableForOrdering(day));
            console.log('Available days for ordering:', available);
            return available;
        }
        
        // ===================================
        // DATE CALCULATION
        // ===================================
        function getDateForDayOfWeek(dayName) {
            const dayIndexMap = {
                'Monday': 0, 'Tuesday': 1, 'Wednesday': 2, 'Thursday': 3,
                'Friday': 4, 'Saturday': 5, 'Sunday': 6
            };

            const today = new Date();
            const jsDow = today.getDay(); // 0=Sun ... 6=Sat

            const activeMonday = new Date(today);
            if (jsDow === 0) {
                activeMonday.setDate(today.getDate() + 1);
            } else {
                activeMonday.setDate(today.getDate() - (jsDow - 1));
            }
            activeMonday.setHours(0,0,0,0);

            const targetDate = new Date(activeMonday);
            targetDate.setDate(activeMonday.getDate() + (dayIndexMap[dayName] ?? 0));

            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthNames[targetDate.getMonth()]} ${targetDate.getDate()}`;
        }
        
        // ===================================
        // INITIALIZATION
        // ===================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Initializing order form...');
            checkCutoffMessage();
            await loadMenu();
            addDay();
            setupEventListeners();
        });
        
        function checkCutoffMessage() {
            const { hour, jsDay } = getCSTParts();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const currentDayName = dayNames[jsDay];
            
            const cutoffMessage = document.getElementById('cutoffMessage');
            const cutoffBanner = document.getElementById('cutoffBanner');
            
            if (hour >= ORDER_CUTOFF_HOUR) {
                cutoffMessage.innerHTML = `It's after 8 PM CST on ${currentDayName}. Orders placed now are for 2+ days ahead. Thank you!`;
                cutoffBanner.style.background = '#fee2e2';
                cutoffBanner.style.color = '#991b1b';
            } else {
                cutoffMessage.innerHTML = 'Orders must be placed by 8 PM CST for next-day delivery.';
            }
        }
        
        // ===================================
        // MENU LOADING
        // ===================================
        async function loadMenu() {
            try {
                console.log('Fetching menu...');
                const response = await fetch(`${SCRIPT_URL}?action=getMenu`);
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                menuData = data.menu || [];
                activeWeek = data.weekLabel || '';
                
                console.log(`Loaded ${menuData.length} menu items for ${activeWeek}`);
                
                document.getElementById('weekLabel').textContent = activeWeek;
                displayMenu();
                
            } catch (error) {
                console.error('Menu load error:', error);
                showError('Failed to load menu. Please refresh the page.');
            }
        }
        
        // ===================================
        // MENU DISPLAY
        // ===================================
        function displayMenu() {
            const menuTabs = document.getElementById('menuTabs');
            const menuContent = document.getElementById('menuContent');
            
            // Group menu by day
            const menuByDay = {};
            menuData.forEach(item => {
                const day = item.DayOfWeek || item.day;
                if (!day) return;
                
                if (!menuByDay[day]) {
                    menuByDay[day] = {};
                }
                
                const itemName = item.ItemName || item.item;
                if (!menuByDay[day][itemName]) {
                    menuByDay[day][itemName] = [];
                }
                
                menuByDay[day][itemName].push(item);
            });
            
            // Create tabs for all days
            menuTabs.innerHTML = '';
            orderDays.forEach((day, index) => {
                const dayDate = getDateForDayOfWeek(day);
                const isOrderable = isDayAvailableForOrdering(day);
                const hasMenu = menuByDay[day] && Object.keys(menuByDay[day]).length > 0;
                
                const tab = document.createElement('div');
                tab.className = 'menu-day-tab' + (!isOrderable ? ' unavailable' : '');
                tab.innerHTML = `
                    <div class="day-name">${day}</div>
                    <div class="day-date">${dayDate}</div>
                    ${!isOrderable ? '<div class="unavailable-text">‚ö†Ô∏è Not Available</div>' : ''}
                `;
                
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.menu-day-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    showDayMenu(day, menuByDay[day] || {}, isOrderable, dayDate);
                });
                
                menuTabs.appendChild(tab);
                
                // Auto-select first available day, or first day with menu
                if (index === 0) {
                    tab.classList.add('active');
                    showDayMenu(day, menuByDay[day] || {}, isOrderable, dayDate);
                }
            });
        }
        
        function showDayMenu(day, dayMenu, isAvailable, dayDate) {
            const menuContent = document.getElementById('menuContent');
            
            if (!dayMenu || Object.keys(dayMenu).length === 0) {
                menuContent.innerHTML = `
                    <div style="background: var(--bg-warm); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--primary);">
                        <h3 style="color: var(--primary); margin: 0 0 0.5rem 0; font-size: 1.2rem;">${day}'s Menu</h3>
                        <p style="color: var(--text-medium); margin: 0; font-size: 0.9rem;">${day}, ${dayDate}</p>
                        ${day === 'Sunday' ? '<p style="color: #b45309; margin: 0.5rem 0 0 0; font-weight: 600;">üìû Sunday orders: Please call us!</p>' : ''}
                    </div>
                    <div class="menu-items-list">
                        <p style="margin: 0; color: var(--text-medium);">No menu items available for ${day}.</p>
                    </div>
                `;
                return;
            }
            
            menuContent.innerHTML = `
                <div style="background: var(--bg-warm); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid var(--primary);">
                    <h3 style="color: var(--primary); margin: 0 0 0.5rem 0; font-size: 1.2rem;">${day}'s Menu</h3>
                    <p style="color: var(--text-medium); margin: 0; font-size: 0.9rem;">${day}, ${dayDate}</p>
                    ${!isAvailable ? `<p style="color: #dc2626; margin: 0.5rem 0 0 0; font-size: 0.85rem; font-weight: 600;">‚ö†Ô∏è ${day === 'Sunday' ? 'Sunday orders: Please call us!' : 'Online ordering not available for this day.'}</p>` : ''}
                </div>
                <div class="menu-items-list">
                    ${Object.keys(dayMenu).map(itemName => {
                        const sizes = dayMenu[itemName];
                        return sizes.map(item => `
                            <div class="menu-item-row">
                                <span class="menu-item-name">${item.ItemName || item.item} <span style="color: var(--text-muted); font-size: 0.85rem;">(${item.Size || item.size})</span></span>
                                <span class="menu-item-price">$${(item.Price || item.price).toFixed(2)}</span>
                            </div>
                        `).join('');
                    }).join('')}
                </div>
            `;
        }
        
        // Continue in next message due to length...
    </script>
</body>
</html>
        
        // ===================================
        // DAY SECTIONS
        // ===================================
        function addDay() {
            dayCounter++;
            const daysContainer = document.getElementById('daysContainer');
            
            const daySection = document.createElement('div');
            daySection.className = 'day-order-section';
            daySection.id = `daySection-${dayCounter}`;
            
            const availableDays = getAvailableDays();
            
            if (availableDays.length === 0) {
                daySection.innerHTML = `
                    <div class="message error">
                        No days available for ordering right now. Please check back later or call us!
                    </div>
                `;
                daysContainer.appendChild(daySection);
                return;
            }
            
            daySection.innerHTML = `
                <select class="day-selector" id="daySelect-${dayCounter}" onchange="handleDayChange(${dayCounter})">
                    <option value="">-- Select a day --</option>
                    ${availableDays.map(day => `<option value="${day}">${day}</option>`).join('')}
                </select>
                <div id="itemsContainer-${dayCounter}"></div>
            `;
            
            daysContainer.appendChild(daySection);
        }
        
        function handleDayChange(dayId) {
            const daySelect = document.getElementById(`daySelect-${dayId}`);
            const selectedDay = daySelect.value;
            const itemsContainer = document.getElementById(`itemsContainer-${dayId}`);
            
            if (!selectedDay) {
                itemsContainer.innerHTML = '';
                return;
            }
            
            // Get items for selected day
            const dayItems = menuData.filter(item => 
                (item.DayOfWeek || item.day) === selectedDay
            );
            
            if (dayItems.length === 0) {
                itemsContainer.innerHTML = `
                    <div class="message error">No menu items found for ${selectedDay}.</div>
                `;
                return;
            }
            
            itemsContainer.innerHTML = `<div id="items-${dayId}"></div>`;
            addItem(dayId);
        }
        
        function addItem(dayId) {
            itemCounter++;
            const itemsDiv = document.getElementById(`items-${dayId}`);
            const daySelect = document.getElementById(`daySelect-${dayId}`);
            const selectedDay = daySelect.value;
            
            if (!selectedDay) {
                showError('Please select a day first');
                return;
            }
            
            const dayItems = menuData.filter(item => 
                (item.DayOfWeek || item.day) === selectedDay
            );
            
            const uniqueItems = [...new Set(dayItems.map(item => item.ItemName || item.item))];
            
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.id = `item-${itemCounter}`;
            itemRow.innerHTML = `
                <select class="item-select" data-item-id="${itemCounter}" data-day="${selectedDay}" required>
                    <option value="">Select item</option>
                    ${uniqueItems.map(item => `<option value="${item}">${item}</option>`).join('')}
                </select>
                <select class="size-select" data-item-id="${itemCounter}" required>
                    <option value="">Select size</option>
                </select>
                <select class="qty-select" data-item-id="${itemCounter}" required>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                </select>
                <button type="button" class="remove-btn" onclick="removeItem(${itemCounter})">‚úï</button>
            `;
            
            itemsDiv.appendChild(itemRow);
            
            // Set up item change listener
            const itemSelect = itemRow.querySelector('.item-select');
            const sizeSelect = itemRow.querySelector('.size-select');
            
            itemSelect.addEventListener('change', function() {
                const selectedItem = this.value;
                sizeSelect.innerHTML = '<option value="">Select size</option>';
                
                if (selectedItem) {
                    const sizes = dayItems.filter(item => 
                        (item.ItemName || item.item) === selectedItem
                    );
                    
                    sizes.forEach(item => {
                        const option = document.createElement('option');
                        option.value = `${item.Size || item.size}|${item.Price || item.price}`;
                        option.textContent = `${item.Size || item.size} - $${(item.Price || item.price).toFixed(2)}`;
                        sizeSelect.appendChild(option);
                    });
                }
                
                updateTotal();
            });
            
            sizeSelect.addEventListener('change', updateTotal);
            itemRow.querySelector('.qty-select').addEventListener('change', updateTotal);
            
            // Add "Add Item" button if not present
            let addItemBtn = itemsDiv.querySelector('.add-item-btn');
            if (!addItemBtn) {
                addItemBtn = document.createElement('button');
                addItemBtn.type = 'button';
                addItemBtn.className = 'add-item-btn';
                addItemBtn.textContent = '+ Add Item';
                itemsDiv.appendChild(addItemBtn);
            }
            
            const newAddItemBtn = addItemBtn.cloneNode(true);
            addItemBtn.parentNode.replaceChild(newAddItemBtn, addItemBtn);
            newAddItemBtn.addEventListener('click', () => addItem(dayId));
        }
        
        function removeItem(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            if (item) {
                item.remove();
                updateTotal();
            }
        }
        
        // ===================================
        // EVENT LISTENERS
        // ===================================
        function setupEventListeners() {
            document.querySelectorAll('input[name="fulfillment"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const deliveryGroup = document.getElementById('deliveryAddressGroup');
                    const deliveryFeeRow = document.getElementById('deliveryFeeRow');
                    
                    if (this.value === 'Delivery') {
                        deliveryGroup.classList.remove('hidden');
                        deliveryFeeRow.classList.remove('hidden');
                    } else {
                        deliveryGroup.classList.add('hidden');
                        deliveryFeeRow.classList.add('hidden');
                    }
                    
                    updateTotal();
                });
            });
            
            document.getElementById('orderForm').addEventListener('submit', handleSubmit);
        }
        
        // ===================================
        // TOTAL CALCULATION
        // ===================================
        function updateTotal() {
            let subtotal = 0;
            const uniqueDays = new Set();
            
            document.querySelectorAll('.item-row').forEach(row => {
                const itemSelect = row.querySelector('.item-select');
                const sizeSelect = row.querySelector('.size-select');
                const qtyInput = row.querySelector('.qty-select');
                
                if (itemSelect && sizeSelect && qtyInput && sizeSelect.value) {
                    const [size, price] = sizeSelect.value.split('|');
                    const qty = parseInt(qtyInput.value) || 0;
                    const lineTotal = parseFloat(price) * qty;
                    subtotal += lineTotal;
                    
                    const day = itemSelect.dataset.day;
                    if (day) uniqueDays.add(day);
                }
            });
            
            const fulfillmentMethod = document.querySelector('input[name="fulfillment"]:checked')?.value;
            const deliveryFee = fulfillmentMethod === 'Delivery' ? uniqueDays.size * 2 : 0;
            const total = subtotal + deliveryFee;
            
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('deliveryFee').textContent = `$${deliveryFee.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }
        
        // ===================================
        // FORM SUBMISSION
        // ===================================
        async function handleSubmit(e) {
            e.preventDefault();
            hideMessages();
            
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const fulfillment = document.querySelector('input[name="fulfillment"]:checked').value;
            const deliveryAddress = fulfillment === 'Delivery' ? document.getElementById('deliveryAddress').value.trim() : '';
            
            if (!name || !phone) {
                showError('Please fill in all required fields.');
                return;
            }
            
            if (fulfillment === 'Delivery' && !deliveryAddress) {
                showError('Please enter a delivery address.');
                return;
            }
            
            // Collect order lines
            const orderLines = [];
            let hasErrors = false;
            
            document.querySelectorAll('.item-row').forEach(row => {
                const itemSelect = row.querySelector('.item-select');
                const sizeSelect = row.querySelector('.size-select');
                const qtyInput = row.querySelector('.qty-select');
                
                if (!itemSelect.value || !sizeSelect.value) {
                    hasErrors = true;
                    return;
                }
                
                // Verify day is still available for ordering
                const day = itemSelect.dataset.day;
                if (!isDayAvailableForOrdering(day)) {
                    hasErrors = true;
                    showError(`${day} is no longer available for ordering (past cutoff time). Please refresh and try again.`);
                    return;
                }
                
                const itemName = itemSelect.value;
                const [size, unitPrice] = sizeSelect.value.split('|');
                const quantity = parseInt(qtyInput.value) || 0;
                const lineTotal = parseFloat(unitPrice) * quantity;
                
                orderLines.push({
                    day: day,
                    itemName: itemName,
                    size: size,
                    quantity: quantity,
                    unitPrice: parseFloat(unitPrice),
                    lineTotal: lineTotal
                });
            });
            
            if (hasErrors || orderLines.length === 0) {
                if (orderLines.length === 0) {
                    showError('Please add at least one item to your order.');
                }
                return;
            }
            
            // Calculate totals
            const subtotal = orderLines.reduce((sum, line) => sum + line.lineTotal, 0);
            const uniqueDays = [...new Set(orderLines.map(line => line.day))];
            const deliveryFee = fulfillment === 'Delivery' ? uniqueDays.length * 2 : 0;
            const total = subtotal + deliveryFee;
            
            const orderData = {
                weekLabel: activeWeek,
                name: name,
                phone: phone,
                email: email,
                fulfillment: fulfillment,
                deliveryAddress: deliveryAddress,
                subtotal: subtotal,
                deliveryFee: deliveryFee,
                total: total,
                orderLines: orderLines
            };
            
            // Submit order
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            try {
                const orderDataEncoded = encodeURIComponent(JSON.stringify(orderData));
                const url = `${SCRIPT_URL}?action=submitOrder&orderData=${orderDataEncoded}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    showSuccess(`‚úÖ Order placed successfully! Order ID: ${result.orderId}`);
                    document.getElementById('orderForm').reset();
                    document.getElementById('daysContainer').innerHTML = '';
                    addDay();
                    updateTotal();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    showError(`Failed to place order: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Submit error:', error);
                showError('Failed to submit order. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Place Order';
            }
        }
        
        // ===================================
        // MESSAGE DISPLAY
        // ===================================
        function showError(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="message error">${message}</div>`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function showSuccess(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="message success">${message}</div>`;
        }
        
        function hideMessages() {
            document.getElementById('messageContainer').innerHTML = '';
        }
    </script>
</body>
</html>
