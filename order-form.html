<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aruna's Kitchen - Weekly Order Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Georgia, 'Times New Roman', serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #8B4513;
        }
        
        .logo {
            max-width: 300px;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }
        
        h1 {
            font-family: Georgia, serif;
            color: #8B4513;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            font-size: 1.3em;
            color: #666;
            font-weight: normal;
            margin-bottom: 5px;
        }
        
        .phone {
            color: #8B4513;
            font-size: 1.1em;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .week-label {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 20px;
            text-align: center;
            font-style: italic;
        }
        
        .cutoff-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 25px;
            font-size: 0.95em;
        }
        
        .cutoff-notice strong {
            display: block;
            margin-bottom: 5px;
            font-size: 1.05em;
        }
        
        .menu-section {
            background: #faf8f5;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            border: 2px solid #d4a574;
        }
        
        .menu-section h2 {
            margin-bottom: 15px;
            color: #8B4513;
            text-align: center;
            font-size: 1.5em;
        }
        
        .menu-by-day {
            margin-bottom: 25px;
        }
        
        .day-menu-header {
            font-weight: bold;
            color: #8B4513;
            font-size: 1.2em;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #d4a574;
            font-family: Georgia, serif;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .menu-item {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #d4a574;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .menu-item-name {
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 8px;
            font-size: 1.05em;
        }
        
        .menu-item-details {
            font-size: 0.9em;
            color: #666;
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .form-section h3 {
            color: #8B4513;
            margin-bottom: 15px;
            border-bottom: 2px solid #d4a574;
            padding-bottom: 8px;
            font-size: 1.3em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="tel"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d4a574;
            border-radius: 4px;
            font-size: 1em;
        }
        
        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 5px rgba(139, 69, 19, 0.3);
        }
        
        select:disabled {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }
        
        select option:disabled {
            color: #999;
        }
        
        input[type="radio"] {
            margin-right: 5px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        
        .day-section {
            background: #faf8f5;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 2px solid #d4a574;
        }
        
        .day-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .day-section-header h4 {
            color: #8B4513;
            font-size: 1.2em;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 100px 40px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #8B4513;
            color: white;
        }
        
        .btn-primary:hover {
            background: #6d3410;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 0.9em;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .order-summary {
            background: #fff9e6;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
            border: 2px solid #d4a574;
        }
        
        .order-summary h3 {
            margin-bottom: 15px;
            color: #8B4513;
        }
        
        .summary-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .summary-total {
            font-weight: bold;
            font-size: 1.2em;
            border-top: 2px solid #8B4513;
            padding-top: 10px;
            margin-top: 10px;
            color: #8B4513;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        
        .confirmation {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .receipt {
            background: #faf8f5;
            padding: 20px;
            border-radius: 6px;
            font-family: monospace;
            border: 2px solid #d4a574;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #8B4513;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .no-items-message {
            color: #666;
            font-style: italic;
            padding: 10px;
            background: #fff3cd;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .tagline {
            text-align: center;
            color: #8B4513;
            font-style: italic;
            margin-top: 10px;
            font-size: 0.95em;
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }
            
            .item-row {
                grid-template-columns: 1fr;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .logo {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 120'%3E%3Ctext x='200' y='60' text-anchor='middle' font-family='Georgia' font-size='48' fill='%238B4513' font-weight='bold'%3EAruna's Kitchen%3C/text%3E%3Ctext x='200' y='90' text-anchor='middle' font-family='Georgia' font-size='18' fill='%23666'%3E+1248-877-9924%3C/text%3E%3C/svg%3E" class="logo" alt="Aruna's Kitchen">
            <h2 class="subtitle">Weekly Order Form</h2>
            <div class="tagline">üçΩÔ∏è Freshly cooked ‚Ä¢ Homestyle flavors</div>
        </div>
        
        <div class="week-label" id="weekLabel">Loading...</div>
        
        <div class="cutoff-notice">
            <strong>‚è∞ Ordering Deadline:</strong>
            Orders must be placed by 8:00 PM the night before. You cannot order for today. After 8:00 PM, you can only order for days that are 2+ days away.
        </div>
        
        <div id="errorMessage" class="error hidden"></div>
        <div id="successMessage" class="success hidden"></div>
        
        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>Loading menu...</p>
        </div>
        
        <div id="formContainer" class="hidden">
            <!-- Menu Display -->
            <div class="menu-section">
                <h2>This Week's Menu</h2>
                <div id="menuDisplay"></div>
            </div>
            
            <!-- Order Form -->
            <form id="orderForm">
                <div class="form-section">
                    <h3>Customer Information</h3>
                    <div class="form-group">
                        <label for="customerName">Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Phone Number *</label>
                        <input type="tel" id="customerPhone" required placeholder="(555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label>Fulfillment Method *</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="fulfillment" value="Pickup" checked>
                                Pickup
                            </label>
                            <label>
                                <input type="radio" name="fulfillment" value="Delivery">
                                Delivery (+$2.00)
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Your Order</h3>
                    <div id="daysContainer"></div>
                    <button type="button" class="btn btn-secondary" onclick="addDay()">+ Add Another Day</button>
                </div>
                
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div id="summaryContent">
                        <p>Add items to see your order summary</p>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success" style="width: 100%; font-size: 1.1em;">Submit Order</button>
            </form>
        </div>
        
        <div id="confirmationContainer" class="hidden">
            <!-- Confirmation will be displayed here -->
        </div>
    </div>
    
    <script>
        // CONFIGURATION
        const DELIVERY_FEE = 2.00;
        const ORDER_CUTOFF_HOUR = 20; // 8 PM (24-hour format)
        const SCRIPT_URL = 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE'; // Replace with your deployed Apps Script URL
        
        // Global state
        let menuData = [];
        let activeWeek = '';
        let dayCounter = 0;
        const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        
        // Calculate current week label
        function getCurrentWeekLabel() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Find Monday of current week
            const monday = new Date(now);
            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            monday.setDate(diff);
            
            // Find Sunday of current week  
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            // Format dates
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const startMonth = monthNames[monday.getMonth()];
            const endMonth = monthNames[sunday.getMonth()];
            const startDay = monday.getDate();
            const endDay = sunday.getDate();
            
            if (startMonth === endMonth) {
                return `Week of ${startMonth} ${startDay} ‚Äì ${endDay}`;
            } else {
                return `Week of ${startMonth} ${startDay} ‚Äì ${endMonth} ${endDay}`;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Show current week immediately
            document.getElementById('weekLabel').textContent = getCurrentWeekLabel();
            await loadMenu();
            addDay(); // Add first day section
            setupFormListeners();
        });
        
        // Check if a day is available for ordering based on current time
        function isDayAvailableForOrdering(dayName) {
            const now = new Date();
            const currentHour = now.getHours();
            const currentDayIndex = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Convert our day names to day indices
            const dayIndexMap = {
                'Sunday': 0,
                'Monday': 1,
                'Tuesday': 2,
                'Wednesday': 3,
                'Thursday': 4,
                'Friday': 5,
                'Saturday': 6
            };
            
            const targetDayIndex = dayIndexMap[dayName];
            
            // Calculate days until target day
            let daysUntil = targetDayIndex - currentDayIndex;
            if (daysUntil < 0) {
                daysUntil += 7; // Next week
            }
            
            // CANNOT order for today (same day)
            if (daysUntil === 0) {
                return false;
            }
            
            // If it's after 8 PM, can only order for days 2+ days away
            if (currentHour >= ORDER_CUTOFF_HOUR) {
                return daysUntil >= 2;
            } else {
                // Before 8 PM, can order for tomorrow onwards (but not today)
                return daysUntil >= 1;
            }
        }
        
        // Get available days based on current time
        function getAvailableDays() {
            return daysOfWeek.filter(day => isDayAvailableForOrdering(day));
        }
        
        // Load menu from Apps Script
        async function loadMenu() {
            showLoading(true);
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getMenu`);
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                menuData = data.menu;
                activeWeek = data.weekLabel;
                
                console.log('Menu data loaded:', menuData); // Debug
                
                // Update week label if we got one from server
                if (activeWeek) {
                    document.getElementById('weekLabel').textContent = activeWeek;
                }
                
                displayMenu();
                showLoading(false);
                document.getElementById('formContainer').classList.remove('hidden');
            } catch (error) {
                showError('Failed to load menu. Please check the SCRIPT_URL configuration.');
                console.error(error);
            }
        }
        
        // Display menu items organized by day
        function displayMenu() {
            const menuDisplay = document.getElementById('menuDisplay');
            const menuByDay = {};
            
            // Group by day - Make sure DayOfWeek field exists
            menuData.forEach(item => {
                const dayOfWeek = item.DayOfWeek || item.dayOfWeek; // Handle both cases
                if (!dayOfWeek) {
                    console.warn('Item missing DayOfWeek:', item);
                    return;
                }
                
                if (!menuByDay[dayOfWeek]) {
                    menuByDay[dayOfWeek] = {};
                }
                if (!menuByDay[dayOfWeek][item.ItemName]) {
                    menuByDay[dayOfWeek][item.ItemName] = [];
                }
                menuByDay[dayOfWeek][item.ItemName].push(item);
            });
            
            console.log('Menu grouped by day:', menuByDay); // Debug
            
            menuDisplay.innerHTML = '';
            
            // Display in day order
            daysOfWeek.forEach(day => {
                if (menuByDay[day]) {
                    const daySection = document.createElement('div');
                    daySection.className = 'menu-by-day';
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-menu-header';
                    dayHeader.textContent = day;
                    
                    // Add availability indicator
                    if (!isDayAvailableForOrdering(day)) {
                        const now = new Date();
                        const currentHour = now.getHours();
                        const currentDayIndex = now.getDay();
                        const dayIndexMap = {
                            'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                            'Thursday': 4, 'Friday': 5, 'Saturday': 6
                        };
                        const targetDayIndex = dayIndexMap[day];
                        let daysUntil = targetDayIndex - currentDayIndex;
                        if (daysUntil < 0) daysUntil += 7;
                        
                        if (daysUntil === 0) {
                            dayHeader.textContent += ' (Cannot order for today)';
                        } else if (currentHour >= ORDER_CUTOFF_HOUR) {
                            dayHeader.textContent += ' (Ordering closed - after 8 PM cutoff)';
                        } else {
                            dayHeader.textContent += ' (Too soon to order)';
                        }
                        dayHeader.style.color = '#999';
                    }
                    
                    daySection.appendChild(dayHeader);
                    
                    const grid = document.createElement('div');
                    grid.className = 'menu-grid';
                    
                    Object.keys(menuByDay[day]).forEach(itemName => {
                        const sizes = menuByDay[day][itemName];
                        const card = document.createElement('div');
                        card.className = 'menu-item';
                        
                        let sizeInfo = sizes.map(s => `${s.Size}: $${s.Price.toFixed(2)}`).join('<br>');
                        
                        card.innerHTML = `
                            <div class="menu-item-name">${itemName}</div>
                            <div class="menu-item-details">${sizeInfo}</div>
                        `;
                        grid.appendChild(card);
                    });
                    
                    daySection.appendChild(grid);
                    menuDisplay.appendChild(daySection);
                }
            });
            
            if (menuDisplay.innerHTML === '') {
                menuDisplay.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No menu items available. Please check your menu data.</p>';
            }
        }
        
        // Add a new day section
        function addDay() {
            dayCounter++;
            const daysContainer = document.getElementById('daysContainer');
            
            const daySection = document.createElement('div');
            daySection.className = 'day-section';
            daySection.id = `day-${dayCounter}`;
            
            const availableDays = getAvailableDays();
            
            daySection.innerHTML = `
                <div class="day-section-header">
                    <h4 id="day-${dayCounter}-title">Select a Day</h4>
                    ${dayCounter > 1 ? `<button type="button" class="btn btn-danger btn-small" onclick="removeDay(${dayCounter})">Remove Day</button>` : ''}
                </div>
                <div class="form-group">
                    <label>Day of Week *</label>
                    <select class="day-select" data-day-id="${dayCounter}" onchange="updateDayItems(${dayCounter})" required>
                        <option value="">Select a day</option>
                        ${daysOfWeek.map(day => {
                            const isAvailable = availableDays.includes(day);
                            const now = new Date();
                            const currentDayIndex = now.getDay();
                            const dayIndexMap = {
                                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                                'Thursday': 4, 'Friday': 5, 'Saturday': 6
                            };
                            const targetDayIndex = dayIndexMap[day];
                            let daysUntil = targetDayIndex - currentDayIndex;
                            if (daysUntil < 0) daysUntil += 7;
                            
                            let disabledReason = '';
                            if (daysUntil === 0) {
                                disabledReason = ' (Cannot order for today)';
                            } else if (!isAvailable) {
                                disabledReason = ' (Not available - see cutoff notice)';
                            }
                            
                            return `<option value="${day}" ${!isAvailable ? 'disabled' : ''}>${day}${disabledReason}</option>`;
                        }).join('')}
                    </select>
                </div>
                <div class="items-container" id="items-container-${dayCounter}"></div>
                <div class="no-items-message" id="no-items-${dayCounter}">Please select a day to see available items</div>
                <button type="button" class="btn btn-primary btn-small" id="add-item-btn-${dayCounter}" onclick="addItem(${dayCounter})" style="display: none;">+ Add Item</button>
            `;
            
            daysContainer.appendChild(daySection);
        }
        
        // Update items when day is selected
        function updateDayItems(dayId) {
            const daySection = document.getElementById(`day-${dayId}`);
            const daySelect = daySection.querySelector('.day-select');
            const selectedDay = daySelect.value;
            const itemsContainer = document.getElementById(`items-container-${dayId}`);
            const noItemsMsg = document.getElementById(`no-items-${dayId}`);
            const addItemBtn = document.getElementById(`add-item-btn-${dayId}`);
            const dayTitle = document.getElementById(`day-${dayId}-title`);
            
            // Update title
            if (selectedDay) {
                dayTitle.textContent = selectedDay;
            } else {
                dayTitle.textContent = 'Select a Day';
            }
            
            // Clear existing items
            itemsContainer.innerHTML = '';
            
            if (!selectedDay) {
                noItemsMsg.style.display = 'block';
                addItemBtn.style.display = 'none';
                updateSummary();
                return;
            }
            
            // Check if there are items for this day
            const availableItems = menuData.filter(item => {
                const dayOfWeek = item.DayOfWeek || item.dayOfWeek;
                return dayOfWeek === selectedDay;
            });
            
            console.log(`Items for ${selectedDay}:`, availableItems); // Debug
            
            if (availableItems.length === 0) {
                noItemsMsg.textContent = `No items available for ${selectedDay}. Please check your menu data.`;
                noItemsMsg.style.display = 'block';
                addItemBtn.style.display = 'none';
            } else {
                noItemsMsg.style.display = 'none';
                addItemBtn.style.display = 'inline-block';
                // Add first item automatically
                addItem(dayId);
            }
            
            updateSummary();
        }
        
        // Remove a day section
        function removeDay(dayId) {
            const daySection = document.getElementById(`day-${dayId}`);
            daySection.remove();
            updateSummary();
        }
        
        // Add item row to a day
        function addItem(dayId) {
            const daySection = document.getElementById(`day-${dayId}`);
            const daySelect = daySection.querySelector('.day-select');
            const selectedDay = daySelect.value;
            
            if (!selectedDay) {
                alert('Please select a day first');
                return;
            }
            
            const itemsContainer = document.getElementById(`items-container-${dayId}`);
            const itemId = Date.now();
            
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.id = `item-${itemId}`;
            
            // Get unique item names for this day
            const availableItems = menuData.filter(item => {
                const dayOfWeek = item.DayOfWeek || item.dayOfWeek;
                return dayOfWeek === selectedDay;
            });
            const uniqueItems = [...new Set(availableItems.map(m => m.ItemName))];
            
            itemRow.innerHTML = `
                <div class="form-group">
                    <label>Item</label>
                    <select class="item-select" data-item-id="${itemId}" data-day="${selectedDay}" onchange="updateSizeOptions(${itemId})">
                        <option value="">Select item</option>
                        ${uniqueItems.map(item => `<option value="${item}">${item}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Size</label>
                    <select class="size-select" data-item-id="${itemId}" onchange="updateSummary()">
                        <option value="">Select size</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Qty</label>
                    <input type="number" class="quantity-input" data-item-id="${itemId}" min="1" value="1" onchange="updateSummary()">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeItem(${itemId})">√ó</button>
                </div>
            `;
            
            itemsContainer.appendChild(itemRow);
        }
        
        // Remove item row
        function removeItem(itemId) {
            const itemRow = document.getElementById(`item-${itemId}`);
            itemRow.remove();
            updateSummary();
        }
        
        // Update size options based on selected item
        function updateSizeOptions(itemId) {
            const itemSelect = document.querySelector(`.item-select[data-item-id="${itemId}"]`);
            const sizeSelect = document.querySelector(`.size-select[data-item-id="${itemId}"]`);
            
            const selectedItem = itemSelect.value;
            const selectedDay = itemSelect.getAttribute('data-day');
            sizeSelect.innerHTML = '<option value="">Select size</option>';
            
            if (selectedItem && selectedDay) {
                const sizes = menuData.filter(m => {
                    const dayOfWeek = m.DayOfWeek || m.dayOfWeek;
                    return m.ItemName === selectedItem && dayOfWeek === selectedDay;
                });
                sizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size.Size;
                    option.textContent = `${size.Size} - $${size.Price.toFixed(2)}`;
                    sizeSelect.appendChild(option);
                });
            }
            
            updateSummary();
        }
        
        // Update order summary
        function updateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const daySections = document.querySelectorAll('.day-section');
            
            let orderItems = [];
            let subtotal = 0;
            
            daySections.forEach(daySection => {
                const daySelect = daySection.querySelector('.day-select');
                const day = daySelect.value;
                
                if (!day) return;
                
                const itemRows = daySection.querySelectorAll('.item-row');
                itemRows.forEach(row => {
                    const itemSelect = row.querySelector('.item-select');
                    const sizeSelect = row.querySelector('.size-select');
                    const quantityInput = row.querySelector('.quantity-input');
                    
                    const itemName = itemSelect.value;
                    const size = sizeSelect.value;
                    const quantity = parseInt(quantityInput.value) || 0;
                    
                    if (itemName && size && quantity > 0) {
                        const menuItem = menuData.find(m => {
                            const dayOfWeek = m.DayOfWeek || m.dayOfWeek;
                            return m.ItemName === itemName && m.Size === size && dayOfWeek === day;
                        });
                        if (menuItem) {
                            const lineTotal = menuItem.Price * quantity;
                            subtotal += lineTotal;
                            orderItems.push({
                                day: day,
                                item: itemName,
                                size: size,
                                quantity: quantity,
                                price: menuItem.Price,
                                lineTotal: lineTotal
                            });
                        }
                    }
                });
            });
            
            const fulfillment = document.querySelector('input[name="fulfillment"]:checked').value;
            const deliveryFee = fulfillment === 'Delivery' ? DELIVERY_FEE : 0;
            const total = subtotal + deliveryFee;
            
            if (orderItems.length === 0) {
                summaryContent.innerHTML = '<p>Add items to see your order summary</p>';
                return;
            }
            
            let html = '';
            const groupedByDay = {};
            orderItems.forEach(item => {
                if (!groupedByDay[item.day]) {
                    groupedByDay[item.day] = [];
                }
                groupedByDay[item.day].push(item);
            });
            
            // Show in day order
            daysOfWeek.forEach(day => {
                if (groupedByDay[day]) {
                    html += `<strong>${day}:</strong><br>`;
                    groupedByDay[day].forEach(item => {
                        html += `<div class="summary-line">
                            <span>${item.item} (${item.size}) x${item.quantity}</span>
                            <span>$${item.lineTotal.toFixed(2)}</span>
                        </div>`;
                    });
                }
            });
            
            html += `<div class="summary-line" style="margin-top: 10px;">
                <span>Subtotal:</span>
                <span>$${subtotal.toFixed(2)}</span>
            </div>`;
            
            if (deliveryFee > 0) {
                html += `<div class="summary-line">
                    <span>Delivery Fee:</span>
                    <span>$${deliveryFee.toFixed(2)}</span>
                </div>`;
            }
            
            html += `<div class="summary-line summary-total">
                <span>Total:</span>
                <span>$${total.toFixed(2)}</span>
            </div>`;
            
            summaryContent.innerHTML = html;
        }
        
        // Setup form listeners
        function setupFormListeners() {
            document.querySelectorAll('input[name="fulfillment"]').forEach(radio => {
                radio.addEventListener('change', updateSummary);
            });
            
            document.getElementById('orderForm').addEventListener('submit', handleSubmit);
        }
        
        // Handle form submission
        async function handleSubmit(e) {
            e.preventDefault();
            hideMessages();
            
            // Validate and collect data
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const fulfillment = document.querySelector('input[name="fulfillment"]:checked').value;
            
            if (!customerName || !customerPhone) {
                showError('Please fill in all required fields.');
                return;
            }
            
            const daySections = document.querySelectorAll('.day-section');
            const orderLines = [];
            let subtotal = 0;
            
            let hasError = false;
            let invalidDays = [];
            
            daySections.forEach(daySection => {
                const daySelect = daySection.querySelector('.day-select');
                const day = daySelect.value;
                
                if (!day) {
                    showError('Please select a day for all day sections.');
                    hasError = true;
                    return;
                }
                
                // Check if day is still available for ordering
                if (!isDayAvailableForOrdering(day)) {
                    invalidDays.push(day);
                    hasError = true;
                    return;
                }
                
                const itemRows = daySection.querySelectorAll('.item-row');
                let hasItems = false;
                
                itemRows.forEach(row => {
                    const itemSelect = row.querySelector('.item-select');
                    const sizeSelect = row.querySelector('.size-select');
                    const quantityInput = row.querySelector('.quantity-input');
                    
                    const itemName = itemSelect.value;
                    const size = sizeSelect.value;
                    const quantity = parseInt(quantityInput.value) || 0;
                    
                    if (itemName || size || quantity > 0) {
                        hasItems = true;
                        if (!itemName || !size || quantity < 1) {
                            showError('Please complete all item fields or remove incomplete items.');
                            hasError = true;
                            return;
                        }
                        
                        const menuItem = menuData.find(m => {
                            const dayOfWeek = m.DayOfWeek || m.dayOfWeek;
                            return m.ItemName === itemName && m.Size === size && dayOfWeek === day;
                        });
                        if (!menuItem) {
                            showError(`Selected item "${itemName}" (${size}) is not available for ${day}.`);
                            hasError = true;
                            return;
                        }
                        
                        const lineTotal = menuItem.Price * quantity;
                        subtotal += lineTotal;
                        
                        orderLines.push({
                            day: day,
                            itemName: itemName,
                            size: size,
                            unitPrice: menuItem.Price,
                            quantity: quantity,
                            lineTotal: lineTotal
                        });
                    }
                });
            });
            
            if (invalidDays.length > 0) {
                const now = new Date();
                const currentHour = now.getHours();
                const currentDayIndex = now.getDay();
                
                let errorMsg = `Cannot place order for: ${invalidDays.join(', ')}. `;
                
                // Check if trying to order for today
                const tryingToOrderToday = invalidDays.some(day => {
                    const dayIndexMap = {
                        'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3,
                        'Thursday': 4, 'Friday': 5, 'Saturday': 6
                    };
                    const targetDayIndex = dayIndexMap[day];
                    let daysUntil = targetDayIndex - currentDayIndex;
                    if (daysUntil < 0) daysUntil += 7;
                    return daysUntil === 0;
                });
                
                if (tryingToOrderToday) {
                    errorMsg += 'You cannot place an order for today. ';
                }
                
                if (currentHour >= ORDER_CUTOFF_HOUR) {
                    errorMsg += `It's after ${ORDER_CUTOFF_HOUR}:00 (8 PM). You can only order for days that are 2 or more days away.`;
                } else {
                    errorMsg += 'Please select days that are at least 1 day away (not today).';
                }
                
                showError(errorMsg);
                return;
            }
            
            if (hasError) return;
            
            if (orderLines.length === 0) {
                showError('Please add at least one item to your order.');
                return;
            }
            
            const deliveryFee = fulfillment === 'Delivery' ? DELIVERY_FEE : 0;
            const total = subtotal + deliveryFee;
            
            const orderData = {
                weekLabel: activeWeek || getCurrentWeekLabel(),
                name: customerName,
                phone: customerPhone,
                fulfillment: fulfillment,
                deliveryFee: deliveryFee,
                subtotal: subtotal,
                total: total,
                orderLines: orderLines
            };
            
            // Submit order using GET to avoid CORS issues
            showLoading(true);
            try {
                const orderDataEncoded = encodeURIComponent(JSON.stringify(orderData));
                const url = `${SCRIPT_URL}?action=submitOrder&orderData=${orderDataEncoded}`;
                
                const response = await fetch(url);
                const result = await response.json();
                showLoading(false);
                
                if (result.error) {
                    showError(result.error);
                    return;
                }
                
                // Show confirmation
                showConfirmation(orderData, result.orderId);
            } catch (error) {
                showLoading(false);
                showError('Failed to submit order. Please try again.');
                console.error(error);
            }
        }
        
        // Show confirmation
        function showConfirmation(orderData, orderId) {
            document.getElementById('formContainer').classList.add('hidden');
            const confirmationContainer = document.getElementById('confirmationContainer');
            confirmationContainer.classList.remove('hidden');
            
            let receiptHtml = `
                <h2 style="color: #8B4513; text-align: center;">Order Confirmed!</h2>
                <p style="text-align: center;">Thank you for your order. Order ID: <strong>${orderId}</strong></p>
                <div class="receipt">
                    <pre>
========================================
        ARUNA'S KITCHEN
        +1248-877-9924
========================================
Order ID: ${orderId}
Week: ${orderData.weekLabel}
Customer: ${orderData.name}
Phone: ${orderData.phone}
Fulfillment: ${orderData.fulfillment}
========================================
`;
            
            const groupedByDay = {};
            orderData.orderLines.forEach(line => {
                if (!groupedByDay[line.day]) {
                    groupedByDay[line.day] = [];
                }
                groupedByDay[line.day].push(line);
            });
            
            daysOfWeek.forEach(day => {
                if (groupedByDay[day]) {
                    receiptHtml += `\n${day}:\n`;
                    groupedByDay[day].forEach(line => {
                        receiptHtml += `  ${line.itemName} (${line.size})\n`;
                        receiptHtml += `    x${line.quantity} @ $${line.unitPrice.toFixed(2)} = $${line.lineTotal.toFixed(2)}\n`;
                    });
                }
            });
            
            receiptHtml += `
========================================
Subtotal:                    $${orderData.subtotal.toFixed(2)}`;
            
            if (orderData.deliveryFee > 0) {
                receiptHtml += `\nDelivery Fee:                 $${orderData.deliveryFee.toFixed(2)}`;
            }
            
            receiptHtml += `
TOTAL:                       $${orderData.total.toFixed(2)}
========================================
Freshly cooked ‚Ä¢ Homestyle flavors
                    </pre>
                </div>
                <button class="btn btn-primary" onclick="location.reload()" style="width: 100%; margin-top: 20px;">Place Another Order</button>
            `;
            
            confirmationContainer.innerHTML = receiptHtml;
        }
        
        // Utility functions
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            window.scrollTo(0, 0);
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }
    </script>
</body>
</html>
